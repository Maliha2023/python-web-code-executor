<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compiler Simulator & AI Debugger</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark Mode background */
        }
        .code-area {
            background-color: #161b22; /* Darker background for code */
            color: #c9d1d9; /* Light text */
            font-family: monospace;
            border: 1px solid #30363d;
        }
        .console-area {
            background-color: #010409;
            color: #e6edf3;
            font-family: monospace;
        }
        .ai-area {
            background-color: #21262d; /* Slightly lighter dark for contrast */
            border-left: 4px solid #58a6ff; /* Blue accent for AI */
            color: #c9d1d9;
        }
        /* Custom scrollbar styling */
        textarea::-webkit-scrollbar, .console-area::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb, .console-area::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-100 mb-6 border-b border-gray-700 pb-3">
            Python Compiler Phases & AI Debugger
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- CODE & INPUT SECTION (Col 1 & 2) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Code Editor -->
                <div>
                    <label for="code" class="block text-sm font-medium text-gray-300 mb-2">Python Code Editor</label>
                    <textarea id="code" rows="15" class="code-area w-full rounded-lg p-4 resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="# Enter your Python code here...
def greet(name):
    print(f'Hello, {name}!')

# Test case for semantic error: uncomment the line below for a Semantic check test
# print(1 / 0)

greet('World')"></textarea>
                </div>

                <!-- Standard Input -->
                <div>
                    <label for="input_data" class="block text-sm font-medium text-gray-300 mb-2">Standard Input (stdin)</label>
                    <textarea id="input_data" rows="3" class="code-area w-full rounded-lg p-4 resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="Optional: Enter input data for the code (e.g., '5&#10;10')"></textarea>
                </div>
            </div>

            <!-- CONTROLS & AI DEBUGGING SECTION (Col 3) -->
            <div class="space-y-6">
                <!-- Controls -->
                <div class="p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-100 mb-4">Compiler Actions</h2>
                    <div class="space-y-3">
                        <button onclick="runCode(false)" id="run-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                            Run Code (Full Execution)
                        </button>
                        
                        <div class="flex items-center space-x-2 p-2 bg-gray-700/50 rounded-lg">
                            <input type="checkbox" id="ai-toggle" checked class="h-4 w-4 text-blue-600 border-gray-600 rounded focus:ring-blue-500">
                            <label for="ai-toggle" class="text-sm text-gray-300 select-none">Enable AI Debugging on Error</label>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-sm text-gray-400 mb-2">Check Specific Phase:</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="checkPhase('lexical')" id="lexical-button" class="phase-button bg-gray-600 hover:bg-gray-700 text-white text-xs py-2 rounded-lg transition duration-200">
                                    Lexical
                                </button>
                                <button onclick="checkPhase('syntax')" id="syntax-button" class="phase-button bg-gray-600 hover:bg-gray-700 text-white text-xs py-2 rounded-lg transition duration-200">
                                    Syntax
                                </button>
                                <button onclick="checkPhase('semantic')" id="semantic-button" class="phase-button bg-gray-600 hover:bg-gray-700 text-white text-xs py-2 rounded-lg transition duration-200">
                                    Semantic
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Debugging Output -->
                <div id="ai-output-container" class="ai-area p-4 rounded-xl shadow-lg transition duration-300 hidden">
                    <h2 class="text-xl font-semibold text-blue-400 mb-3">ðŸ¤– AI Debugging Assistant</h2>
                    <div id="ai-output" class="text-sm whitespace-pre-wrap overflow-auto max-h-96"></div>
                </div>
            </div>
        </div>

        <!-- OUTPUT CONSOLE SECTION -->
        <div class="mt-6">
            <h2 class="text-xl font-semibold text-gray-100 mb-3">Execution Console & Error Trace</h2>
            <div id="console-output" class="console-area p-4 rounded-lg shadow-inner border border-gray-700 overflow-auto max-h-96 text-sm">
                Awaiting code execution...
            </div>
        </div>

    </div>

    <script>
        const codeEditor = document.getElementById('code');
        const inputData = document.getElementById('input_data');
        const consoleOutput = document.getElementById('console-output');
        const aiOutput = document.getElementById('ai-output');
        const aiOutputContainer = document.getElementById('ai-output-container');
        const runButton = document.getElementById('run-button');
        const aiToggle = document.getElementById('ai-toggle');
        const phaseButtons = document.querySelectorAll('.phase-button');

        // Helper function to disable/enable controls during processing
        function setControlsDisabled(disabled, buttonId = null) {
            runButton.disabled = disabled;
            phaseButtons.forEach(btn => btn.disabled = disabled);

            if (buttonId) {
                if (disabled) {
                    document.getElementById(buttonId).textContent = 'Processing...';
                    document.getElementById(buttonId).classList.add('opacity-70', 'cursor-not-allowed');
                } else {
                    // Reset all buttons to original text/style
                    document.getElementById('run-button').textContent = 'Run Code (Full Execution)';
                    document.getElementById('lexical-button').textContent = 'Lexical';
                    document.getElementById('syntax-button').textContent = 'Syntax';
                    document.getElementById('semantic-button').textContent = 'Semantic';
                    document.querySelectorAll('.phase-button, #run-button').forEach(btn => {
                        btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    });
                }
            }
        }

        async function postData(url, data) {
            // Function to handle the fetch request
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return { 
                    status: 'error', 
                    error: `Network or Server Error: ${error.message}. Ensure the backend is running.`,
                    output: `[NETWORK ERROR] Could not connect to the backend server. Please check the network or server status.`
                };
            }
        }
        
        // --- Full Execution & AI Debugging ---
        async function runCode() {
            setControlsDisabled(true, 'run-button');
            aiOutputContainer.classList.add('hidden');
            aiOutput.textContent = '';
            consoleOutput.innerHTML = '<span class="text-blue-400">Executing code and checking for errors...</span>';

            const payload = {
                code: codeEditor.value,
                input_data: inputData.value,
                ai_enabled: aiToggle.checked
            };

            const result = await postData('/execute', payload);

            consoleOutput.textContent = result.output || result.error || 'No output or error received.';
            
            if (result.status === 'error' && result.ai_suggestion) {
                aiOutput.textContent = result.ai_suggestion;
                aiOutputContainer.classList.remove('hidden');
            } else if (result.status === 'success') {
                aiOutput.textContent = result.ai_suggestion || "Code executed successfully.";
                aiOutputContainer.classList.remove('hidden');
                // Highlight successful execution status
                consoleOutput.innerHTML = `<span class="text-green-400">--- Execution Successful ---</span>\n\n${consoleOutput.textContent}`;
            }

            setControlsDisabled(false, 'run-button');
        }

        // --- Phase Check Utility ---
        async function checkPhase(phase) {
            setControlsDisabled(true, `${phase}-button`);
            aiOutputContainer.classList.add('hidden');
            aiOutput.textContent = '';
            consoleOutput.innerHTML = `<span class="text-yellow-400">Running Phase Check: ${phase.toUpperCase()}...</span>`;

            const payload = {
                code: codeEditor.value,
                phase: phase,
                input_data: inputData.value
            };

            const result = await postData('/check_phase', payload);

            let message = `<span class="font-bold">Phase: ${phase.toUpperCase()} Check Result:</span> `;
            let outputContent = result.output;

            if (result.status === 'success') {
                message += `<span class="text-green-400">SUCCESS</span>\n`;
                message += `Message: ${result.message}\n`;
                if (outputContent) {
                    message += `\n--- Standard Output (stdout) ---\n${outputContent}`;
                }
            } else {
                message += `<span class="text-red-400">ERROR!</span>\n`;
                message += `Message: ${result.message}\n`;
                message += `Error Details:\n${result.error || 'Unknown error'}`;
            }

            consoleOutput.textContent = message;
            setControlsDisabled(false, `${phase}-button`);
        }
    </script>
</body>
</html>
